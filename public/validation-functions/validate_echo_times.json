{
  "id": "validate_echo_times",
  "name": "TE Close to T2*",
  "description": "The longest TE (the TE of the last echo) should be equal to at least the T2* value of the tissue of interest.",
  "category": "Echo Timing",
  "fields": ["EchoTime", "MagneticFieldStrength"],
  "requiredSystemFields": [],
  "parameters": null,
  "implementation": "echo_times = value[\"EchoTime\"].dropna().sort_values()\nfield_strength = value[\"MagneticFieldStrength\"].iloc[0]\n\ntissue_values = {\n    1.5: {\"grey\": 84.0, \"white\": 66.2, \"caudate\": 58.8, \"putamen\": 55.5},\n    3.0: {\"grey\": 66.0, \"white\": 53.2, \"caudate\": 41.3, \"putamen\": 31.5},\n    7.0: {\"grey\": 33.2, \"white\": 26.8, \"caudate\": 19.9, \"putamen\": 16.1},\n}\n\nmax_tissue = max(tissue_values[field_strength].values())\nmin_tissue = min(tissue_values[field_strength].values())\n\nif echo_times.iloc[-1] > 1.25 * max_tissue:\n    raise ValidationError(f\"The longest TE should be ≤1.25x the highest tissue T2* ({max_tissue} ms).\")\nif echo_times.iloc[-1] < 0.75 * min_tissue:\n    raise ValidationError(f\"The longest TE should be ≥0.75x the lowest tissue T2* ({min_tissue} ms).\")\nreturn value",
  "testCases": [
    {
      "id": "valid_te_range",
      "name": "Valid TE Range Test",
      "description": "Should pass with longest TE in valid range for 3T",
      "expectedToPass": true,
      "data": {
        "EchoTime": [10.0, 20.0, 30.0, 40.0],
        "MagneticFieldStrength": [3.0, 3.0, 3.0, 3.0]
      }
    },
    {
      "id": "te_too_long",
      "name": "TE Too Long Test",
      "description": "Should fail with longest TE > 1.25x max T2*",
      "expectedToPass": false,
      "data": {
        "EchoTime": [10.0, 30.0, 60.0, 100.0],
        "MagneticFieldStrength": [3.0, 3.0, 3.0, 3.0]
      }
    }
  ]
}